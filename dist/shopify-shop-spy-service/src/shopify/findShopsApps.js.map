{
  "version": 3,
  "sources": ["../../../../src/shopify/findShopsApps.ts"],
  "sourcesContent": ["/* eslint-disable no-control-regex */\nimport {\n  getAppsCollection,\n  getShopsCollection,\n} from '@src/mongodb/collections';\nimport { ShopStatus } from '@src/types/shop-model';\nimport axios from 'axios';\nimport { ObjectId } from 'mongodb';\n\nconst appsFromCommentsRegex =\n  /<!-- BEGIN app block: shopify:\\/\\/apps\\/([^/]+)/g;\nconst appsFromAsyncLoadFunctionRegex =\n  /function\\s*asyncLoad\\(\\)\\s*{\\s*var\\s*urls\\s*=\\s*\\[([^\\]]+)/;\n\nfunction collectAppsFromAsyncLoadFunction(html: string) {\n  try {\n    return html.match(appsFromAsyncLoadFunctionRegex)[1].split(',');\n  } catch {\n    console.error('Error while collecting apps from async load function');\n    return [];\n  }\n}\n\nfunction collectAppsFromComments(html: string) {\n  return [...html.matchAll(appsFromCommentsRegex)].map((e) => e[1]);\n}\n\nasync function findShopApps(shopUrl: string) {\n  const html = (await axios.get(shopUrl)).data.replace(/\\r|\\n/g, '');\n  const apps = {\n    fromComments: collectAppsFromComments(html),\n    fromAsyncLoadFunction: collectAppsFromAsyncLoadFunction(html),\n  };\n\n  return apps;\n}\n\nexport async function findShopsApps() {\n  const shopsCollection = getShopsCollection();\n  const appsCollection = getAppsCollection();\n\n  const shops = await shopsCollection\n    .find({ status: ShopStatus.ACTIVE, subscribersCount: { $gt: 0 } })\n    .project({ url: 1 })\n    .toArray();\n\n  const apps = (await appsCollection.find({}).toArray()).map((app) => {\n    return {\n      ...app,\n      flatName: app.name\n        .toLowerCase()\n        .replace(/\\s|:/g, '-')\n        .replace(/[^\\x00-\\x7F]+/g, '-')\n        .replace(/-+/g, '-'),\n    };\n  });\n  console.info('Get apps from database :', apps.length);\n\n  //   const shops = ['https://lumaluxpro.com/'];\n\n  console.info('Get shops from database :', shops.length);\n  let successCount = 0;\n  let errorCount = 0;\n  for (const shop of shops) {\n    try {\n      const foundApps = await findShopApps(shop.url);\n      const shopApps: ObjectId[] = [];\n\n      console.info('Found apps :');\n      console.info(foundApps.fromComments);\n      for (const foundApp of foundApps.fromComments) {\n        const app = apps.find((e) => e.flatName === foundApp);\n\n        if (app) {\n          console.info('Found app :', app.name);\n          shopApps.push(app._id);\n          successCount++;\n        } else {\n          console.info('Not found app :', foundApp);\n          errorCount++;\n        }\n      }\n      await shopsCollection.updateOne(\n        { _id: shop._id },\n        { $set: { installedApps: shopApps } }\n      );\n    } catch (error) {\n      console.error('Error while finding shop apps :', error.message);\n    }\n  }\n  console.info('Success count :', successCount);\n  console.info('Error count :', errorCount);\n}\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AACA,yBAGO;AACP,wBAA2B;AAC3B,mBAAkB;AAGlB,MAAM,wBACJ;AACF,MAAM,iCACJ;AAEF,SAAS,iCAAiC,MAAc;AACtD,MAAI;AACF,WAAO,KAAK,MAAM,8BAA8B,EAAE,CAAC,EAAE,MAAM,GAAG;AAAA,EAChE,QAAE;AACA,YAAQ,MAAM,sDAAsD;AACpE,WAAO,CAAC;AAAA,EACV;AACF;AAEA,SAAS,wBAAwB,MAAc;AAC7C,SAAO,CAAC,GAAG,KAAK,SAAS,qBAAqB,CAAC,EAAE,IAAI,CAAC,MAAM,EAAE,CAAC,CAAC;AAClE;AAEA,eAAe,aAAa,SAAiB;AAC3C,QAAM,QAAQ,MAAM,aAAAA,QAAM,IAAI,OAAO,GAAG,KAAK,QAAQ,UAAU,EAAE;AACjE,QAAM,OAAO;AAAA,IACX,cAAc,wBAAwB,IAAI;AAAA,IAC1C,uBAAuB,iCAAiC,IAAI;AAAA,EAC9D;AAEA,SAAO;AACT;AAEA,eAAsB,gBAAgB;AACpC,QAAM,sBAAkB,uCAAmB;AAC3C,QAAM,qBAAiB,sCAAkB;AAEzC,QAAM,QAAQ,MAAM,gBACjB,KAAK,EAAE,QAAQ,6BAAW,QAAQ,kBAAkB,EAAE,KAAK,EAAE,EAAE,CAAC,EAChE,QAAQ,EAAE,KAAK,EAAE,CAAC,EAClB,QAAQ;AAEX,QAAM,QAAQ,MAAM,eAAe,KAAK,CAAC,CAAC,EAAE,QAAQ,GAAG,IAAI,CAAC,QAAQ;AAClE,WAAO;AAAA,MACL,GAAG;AAAA,MACH,UAAU,IAAI,KACX,YAAY,EACZ,QAAQ,SAAS,GAAG,EACpB,QAAQ,kBAAkB,GAAG,EAC7B,QAAQ,OAAO,GAAG;AAAA,IACvB;AAAA,EACF,CAAC;AACD,UAAQ,KAAK,4BAA4B,KAAK,MAAM;AAIpD,UAAQ,KAAK,6BAA6B,MAAM,MAAM;AACtD,MAAI,eAAe;AACnB,MAAI,aAAa;AACjB,aAAW,QAAQ,OAAO;AACxB,QAAI;AACF,YAAM,YAAY,MAAM,aAAa,KAAK,GAAG;AAC7C,YAAM,WAAuB,CAAC;AAE9B,cAAQ,KAAK,cAAc;AAC3B,cAAQ,KAAK,UAAU,YAAY;AACnC,iBAAW,YAAY,UAAU,cAAc;AAC7C,cAAM,MAAM,KAAK,KAAK,CAAC,MAAM,EAAE,aAAa,QAAQ;AAEpD,YAAI,KAAK;AACP,kBAAQ,KAAK,eAAe,IAAI,IAAI;AACpC,mBAAS,KAAK,IAAI,GAAG;AACrB;AAAA,QACF,OAAO;AACL,kBAAQ,KAAK,mBAAmB,QAAQ;AACxC;AAAA,QACF;AAAA,MACF;AACA,YAAM,gBAAgB;AAAA,QACpB,EAAE,KAAK,KAAK,IAAI;AAAA,QAChB,EAAE,MAAM,EAAE,eAAe,SAAS,EAAE;AAAA,MACtC;AAAA,IACF,SAAS,OAAP;AACA,cAAQ,MAAM,mCAAmC,MAAM,OAAO;AAAA,IAChE;AAAA,EACF;AACA,UAAQ,KAAK,mBAAmB,YAAY;AAC5C,UAAQ,KAAK,iBAAiB,UAAU;AAC1C;",
  "names": ["axios"]
}
