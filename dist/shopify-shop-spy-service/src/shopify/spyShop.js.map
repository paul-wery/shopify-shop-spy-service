{
  "version": 3,
  "sources": ["../../../../src/shopify/spyShop.ts"],
  "sourcesContent": ["import { updateShop } from '@src/mongodb/updateShop';\nimport { ShopifyProduct } from '@src/types';\nimport { ShopModel } from '@src/types/shop-model';\nimport { ShopProductModel } from '@src/types/shop-product-model';\nimport dayjs from 'dayjs';\nimport { WithId } from 'mongodb';\nimport { getShopProducts } from './getShopProducts';\n\nfunction defaultProductFromShopifyProduct(product: ShopifyProduct) {\n  return {\n    url: product.handle,\n    name: product.title,\n    image: product.images[0]?.src,\n    price: parseFloat(product.variants[0].price),\n    createdAt: dayjs(product.published_at).unix(),\n    lastSaleAt: 0,\n    sales: [],\n  };\n}\n\nconst updateProductSalesData = async (\n  shopifyProduct: ShopifyProduct,\n  product: ShopProductModel,\n  currentTime: number\n) => {\n  const variants = shopifyProduct.variants;\n  const lastCount = product.sales[product.sales.length - 1].count;\n\n  if (lastCount === -1) {\n    product.sales[product.sales.length - 1].count = 0;\n  } else {\n    for (const variant of variants) {\n      if (product.lastSaleAt < dayjs(variant.updated_at).unix()) {\n        product.sales[product.sales.length - 1].count += 1;\n      }\n    }\n  }\n  product.lastSaleAt = currentTime;\n  return product;\n};\n\nasync function createMissingOrUpdateProducts(shop: WithId<ShopModel>) {\n  const shopProducts: ShopProductModel[] = [];\n  const shopifyProducts = await getShopProducts(shop.url);\n  const currentTime = dayjs().unix();\n  const currentHour = dayjs().startOf('hour').unix();\n\n  for (let index = 0; index < shopifyProducts.length; index++) {\n    const shopifyProduct = shopifyProducts[index];\n    const shopProduct = shop.products.find(\n      (product) => product.url === shopifyProduct.handle\n    );\n    const defaultShopProduct = defaultProductFromShopifyProduct(shopifyProduct);\n\n    if (shopProduct) {\n      defaultShopProduct.lastSaleAt = shopProduct.lastSaleAt;\n      defaultShopProduct.sales = shopProduct.sales;\n    } else {\n      defaultShopProduct.sales = [{ date: currentHour, count: -1 }];\n    }\n\n    const lastSale =\n      defaultShopProduct.sales[defaultShopProduct.sales.length - 1];\n\n    if (lastSale.date !== currentHour) {\n      defaultShopProduct.sales.push({ date: currentHour, count: 0 });\n    }\n    await updateProductSalesData(\n      shopifyProduct,\n      defaultShopProduct,\n      currentTime\n    );\n    shopProducts.push(defaultShopProduct);\n  }\n  shop.products = shopProducts;\n}\n\nexport async function spyShop(shop: WithId<ShopModel>) {\n  try {\n    shop.products = shop.products || [];\n    console.log('START', shop.url);\n    await createMissingOrUpdateProducts(shop);\n    console.log('END', shop.url);\n    await updateShop(shop);\n  } catch (error) {\n    console.error(`Catched error on shop ${shop.url}`, error.message);\n  }\n}\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,wBAA2B;AAI3B,mBAAkB;AAElB,6BAAgC;AAEhC,SAAS,iCAAiC,SAAyB;AACjE,SAAO;AAAA,IACL,KAAK,QAAQ;AAAA,IACb,MAAM,QAAQ;AAAA,IACd,OAAO,QAAQ,OAAO,CAAC,GAAG;AAAA,IAC1B,OAAO,WAAW,QAAQ,SAAS,CAAC,EAAE,KAAK;AAAA,IAC3C,eAAW,aAAAA,SAAM,QAAQ,YAAY,EAAE,KAAK;AAAA,IAC5C,YAAY;AAAA,IACZ,OAAO,CAAC;AAAA,EACV;AACF;AAEA,MAAM,yBAAyB,OAC7B,gBACA,SACA,gBACG;AACH,QAAM,WAAW,eAAe;AAChC,QAAM,YAAY,QAAQ,MAAM,QAAQ,MAAM,SAAS,CAAC,EAAE;AAE1D,MAAI,cAAc,IAAI;AACpB,YAAQ,MAAM,QAAQ,MAAM,SAAS,CAAC,EAAE,QAAQ;AAAA,EAClD,OAAO;AACL,eAAW,WAAW,UAAU;AAC9B,UAAI,QAAQ,iBAAa,aAAAA,SAAM,QAAQ,UAAU,EAAE,KAAK,GAAG;AACzD,gBAAQ,MAAM,QAAQ,MAAM,SAAS,CAAC,EAAE,SAAS;AAAA,MACnD;AAAA,IACF;AAAA,EACF;AACA,UAAQ,aAAa;AACrB,SAAO;AACT;AAEA,eAAe,8BAA8B,MAAyB;AACpE,QAAM,eAAmC,CAAC;AAC1C,QAAM,kBAAkB,UAAM,wCAAgB,KAAK,GAAG;AACtD,QAAM,kBAAc,aAAAA,SAAM,EAAE,KAAK;AACjC,QAAM,kBAAc,aAAAA,SAAM,EAAE,QAAQ,MAAM,EAAE,KAAK;AAEjD,WAAS,QAAQ,GAAG,QAAQ,gBAAgB,QAAQ,SAAS;AAC3D,UAAM,iBAAiB,gBAAgB,KAAK;AAC5C,UAAM,cAAc,KAAK,SAAS;AAAA,MAChC,CAAC,YAAY,QAAQ,QAAQ,eAAe;AAAA,IAC9C;AACA,UAAM,qBAAqB,iCAAiC,cAAc;AAE1E,QAAI,aAAa;AACf,yBAAmB,aAAa,YAAY;AAC5C,yBAAmB,QAAQ,YAAY;AAAA,IACzC,OAAO;AACL,yBAAmB,QAAQ,CAAC,EAAE,MAAM,aAAa,OAAO,GAAG,CAAC;AAAA,IAC9D;AAEA,UAAM,WACJ,mBAAmB,MAAM,mBAAmB,MAAM,SAAS,CAAC;AAE9D,QAAI,SAAS,SAAS,aAAa;AACjC,yBAAmB,MAAM,KAAK,EAAE,MAAM,aAAa,OAAO,EAAE,CAAC;AAAA,IAC/D;AACA,UAAM;AAAA,MACJ;AAAA,MACA;AAAA,MACA;AAAA,IACF;AACA,iBAAa,KAAK,kBAAkB;AAAA,EACtC;AACA,OAAK,WAAW;AAClB;AAEA,eAAsB,QAAQ,MAAyB;AACrD,MAAI;AACF,SAAK,WAAW,KAAK,YAAY,CAAC;AAClC,YAAQ,IAAI,SAAS,KAAK,GAAG;AAC7B,UAAM,8BAA8B,IAAI;AACxC,YAAQ,IAAI,OAAO,KAAK,GAAG;AAC3B,cAAM,8BAAW,IAAI;AAAA,EACvB,SAAS,OAAP;AACA,YAAQ,MAAM,yBAAyB,KAAK,OAAO,MAAM,OAAO;AAAA,EAClE;AACF;",
  "names": ["dayjs"]
}
