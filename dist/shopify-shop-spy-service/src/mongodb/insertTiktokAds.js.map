{
  "version": 3,
  "sources": ["../../../../src/mongodb/insertTiktokAds.ts"],
  "sourcesContent": ["import { uploadVideos } from '@src/firebase/uploadTiktokAdVideo';\nimport { TiktokAdModel } from '@src/types/tiktok-ad-model';\nimport { ObjectId, WithId } from 'mongodb';\nimport { getTiktokAdsCollection } from './collections';\nimport { convertToObjectId } from './convertToObjectId';\n\nexport async function insertTiktokAds(_ads: TiktokAdModel[]) {\n  const collection = getTiktokAdsCollection();\n  const ads: WithId<TiktokAdModel>[] = _ads.map((ad) => ({\n    ...ad,\n    _id: convertToObjectId(ad.adId),\n  }));\n\n  try {\n    const result = await collection.insertMany(ads, { ordered: false });\n\n    console.info(`Inserted ${result.insertedCount} ads`);\n\n    await uploadVideos(ads);\n  } catch (error) {\n    const toUpdate: (TiktokAdModel & { _id: ObjectId })[] =\n      error.writeErrors.map((error) => error.err.op);\n\n    await Promise.all(\n      toUpdate.map((ad) => {\n        const { _id, ...data } = ad;\n\n        return collection.updateOne({ _id }, { $set: data });\n      })\n    );\n    console.info(`Inserted ${error.result.insertedCount} ads`);\n    console.info(`Updated ${toUpdate.length} ads`);\n\n    const videosToUpload = ads.filter(\n      (ad) => !toUpdate.find((u) => u.adId === ad.adId)\n    );\n\n    await uploadVideos(videosToUpload);\n  }\n}\n"],
  "mappings": ";;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,iCAA6B;AAG7B,yBAAuC;AACvC,+BAAkC;AAElC,eAAsB,gBAAgB,MAAuB;AAC3D,QAAM,iBAAa,2CAAuB;AAC1C,QAAM,MAA+B,KAAK,IAAI,CAAC,QAAQ;AAAA,IACrD,GAAG;AAAA,IACH,SAAK,4CAAkB,GAAG,IAAI;AAAA,EAChC,EAAE;AAEF,MAAI;AACF,UAAM,SAAS,MAAM,WAAW,WAAW,KAAK,EAAE,SAAS,MAAM,CAAC;AAElE,YAAQ,KAAK,YAAY,OAAO,mBAAmB;AAEnD,cAAM,yCAAa,GAAG;AAAA,EACxB,SAAS,OAAP;AACA,UAAM,WACJ,MAAM,YAAY,IAAI,CAACA,WAAUA,OAAM,IAAI,EAAE;AAE/C,UAAM,QAAQ;AAAA,MACZ,SAAS,IAAI,CAAC,OAAO;AACnB,cAAM,EAAE,KAAK,GAAG,KAAK,IAAI;AAEzB,eAAO,WAAW,UAAU,EAAE,IAAI,GAAG,EAAE,MAAM,KAAK,CAAC;AAAA,MACrD,CAAC;AAAA,IACH;AACA,YAAQ,KAAK,YAAY,MAAM,OAAO,mBAAmB;AACzD,YAAQ,KAAK,WAAW,SAAS,YAAY;AAE7C,UAAM,iBAAiB,IAAI;AAAA,MACzB,CAAC,OAAO,CAAC,SAAS,KAAK,CAAC,MAAM,EAAE,SAAS,GAAG,IAAI;AAAA,IAClD;AAEA,cAAM,yCAAa,cAAc;AAAA,EACnC;AACF;",
  "names": ["error"]
}
